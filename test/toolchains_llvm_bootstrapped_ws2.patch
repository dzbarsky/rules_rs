commit c719f8e060e32e5b42f47d1fd6fc94fdece2c1f9
Author: David Zbarsky <dzbarsky@gmail.com>
Date:   Wed Dec 24 21:13:48 2025 -0500

    Flesh out libws2_32

diff --git a/runtimes/mingw/BUILD.bazel b/runtimes/mingw/BUILD.bazel
index f3113ab..995c9d4 100644
--- a/runtimes/mingw/BUILD.bazel
+++ b/runtimes/mingw/BUILD.bazel
@@ -184,6 +184,51 @@ cc_stage2_static_library(
     deps = [":moldname_crt_lib"],
 )
 
+run_binary(
+    name = "libsynchronization",
+    srcs = [
+        "@mingw//:import_lib_api-ms-win-core-synch-l1-2-0",
+    ],
+    outs = ["libsynchronization.a"],
+    tool = "@toolchains_llvm_bootstrapped//tools:llvm-ar",
+    args = [
+        "qcsDL",
+        "$(location :libsynchronization.a)",
+        "$(location @mingw//:import_lib_api-ms-win-core-synch-l1-2-0)",
+    ],
+)
+
+cc_stage2_library(
+    name = "ws2_32_lib",
+    srcs = ["@mingw//:ws2_32_srcs"],
+    implementation_deps = [
+        "@mingw//:mingw_headers",
+        "@mingw//:mingw_crt_headers",
+    ],
+    copts = MINGW_CRT_COMMON_COPTS,
+)
+
+cc_stage2_static_library(
+    name = "ws2_32",
+    deps = [":ws2_32_lib"],
+)
+
+run_binary(
+    name = "libws2_32",
+    srcs = [
+        "@mingw//:import_lib_ws2_32",
+        ":ws2_32",
+    ],
+    outs = ["libws2_32.a"],
+    tool = "@toolchains_llvm_bootstrapped//tools:llvm-ar",
+    args = [
+        "qcsDL",
+        "$(location :libws2_32.a)",
+        "$(location @mingw//:import_lib_ws2_32)",
+        "$(location :ws2_32)",
+    ],
+)
+
 cc_stage2_library(
     name = "uuid_lib",
     srcs = ["@mingw//:mingw_uuid_srcs"],
@@ -232,6 +277,8 @@ copy_to_directory(
     name = "mingw_import_libraries_directory",
     srcs = [
         "@mingw//:mingw_import_libraries_common",
+        ":libsynchronization.a",
+        ":libws2_32.a",
     ] + select({
         "@platforms//cpu:x86_64": ["@mingw//:mingw_import_libraries_x86_64"],
         # Aarch64 are fully templatized in .def.in files, x86_64 have not been merged yet.
diff --git a/runtimes/mingw/BUILD.tpl b/runtimes/mingw/BUILD.tpl
index d1c13a2..d37d08d 100644
--- a/runtimes/mingw/BUILD.tpl
+++ b/runtimes/mingw/BUILD.tpl
@@ -5,6 +5,7 @@ load("@bazel_skylib//rules:write_file.bzl", "write_file")
 load("@bazel_lib//lib:run_binary.bzl", "run_binary")
 load("@toolchains_llvm_bootstrapped//runtimes/mingw:import_libs.bzl", "mingw_import_libraries")
 load("@toolchains_llvm_bootstrapped//toolchain/stage2:cc_stage2_library.bzl", "cc_stage2_library")
+load("@toolchains_llvm_bootstrapped//toolchain/stage2:cc_stage2_static_library.bzl", "cc_stage2_static_library")
 load(
     "@toolchains_llvm_bootstrapped//runtimes/mingw:crt_sources.bzl",
     "MINGW32_HDRS",
@@ -20,6 +21,7 @@ load(
     "UUID_SRCS",
     "UCRT_BASE_SRCS",
     "UCRT_BASE_X86_64_ADDITIONAL_SRCS",
+    "WS2_32_SRCS",
 )
 
 package(default_visibility = ["//visibility:public"])
@@ -89,6 +91,11 @@ filegroup(
     srcs = ["mingw-w64-crt/%s" % path for path in UCRT_BASE_SRCS],
 )
 
+filegroup(
+    name = "ws2_32_srcs",
+    srcs = ["mingw-w64-crt/%s" % path for path in WS2_32_SRCS],
+)
+
 filegroup(
     name = "moldname_crt_srcs",
     srcs = [":libm_dummy_source"],
@@ -188,30 +195,8 @@ subdirectory(
 )
 
 mingw_import_libraries(
-    name = "mingw_import_libraries_common_base",
-    directory = "mingw-w64-crt/lib-common",
-)
-
-run_binary(
-    name = "libsynchronization",
-    srcs = [
-        ":import_lib_api-ms-win-core-synch-l1-2-0",
-    ],
-    outs = ["libsynchronization.a"],
-    tool = "@toolchains_llvm_bootstrapped//tools:llvm-ar",
-    args = [
-        "qcsDL",
-        "$(location libsynchronization.a)",
-        "$(location import_lib_api-ms-win-core-synch-l1-2-0)",
-    ],
-)
-
-filegroup(
     name = "mingw_import_libraries_common",
-    srcs = [
-        ":mingw_import_libraries_common_base",
-        ":libsynchronization",
-    ],
+    directory = "mingw-w64-crt/lib-common",
 )
 
 mingw_import_libraries(
diff --git a/runtimes/mingw/crt_sources.bzl b/runtimes/mingw/crt_sources.bzl
index 7683825..3cb66f8 100644
--- a/runtimes/mingw/crt_sources.bzl
+++ b/runtimes/mingw/crt_sources.bzl
@@ -475,6 +475,44 @@ UUID_SRCS = [
     "libsrc/windowscodecs.c",
 ]
 
+WS2_32_SRCS = [
+    "libsrc/ws2_32.c",
+    "libsrc/ws2tcpip/in6_addr_equal.c",
+    "libsrc/ws2tcpip/in6addr_isany.c",
+    "libsrc/ws2tcpip/in6addr_isloopback.c",
+    "libsrc/ws2tcpip/in6addr_setany.c",
+    "libsrc/ws2tcpip/in6addr_setloopback.c",
+    "libsrc/ws2tcpip/in6_is_addr_linklocal.c",
+    "libsrc/ws2tcpip/in6_is_addr_loopback.c",
+    "libsrc/ws2tcpip/in6_is_addr_mc_global.c",
+    "libsrc/ws2tcpip/in6_is_addr_mc_linklocal.c",
+    "libsrc/ws2tcpip/in6_is_addr_mc_nodelocal.c",
+    "libsrc/ws2tcpip/in6_is_addr_mc_orglocal.c",
+    "libsrc/ws2tcpip/in6_is_addr_mc_sitelocal.c",
+    "libsrc/ws2tcpip/in6_is_addr_multicast.c",
+    "libsrc/ws2tcpip/in6_is_addr_sitelocal.c",
+    "libsrc/ws2tcpip/in6_is_addr_unspecified.c",
+    "libsrc/ws2tcpip/in6_is_addr_v4compat.c",
+    "libsrc/ws2tcpip/in6_is_addr_v4mapped.c",
+    "libsrc/ws2tcpip/in6_set_addr_loopback.c",
+    "libsrc/ws2tcpip/in6_set_addr_unspecified.c",
+    "libsrc/ws2tcpip/gai_strerrorA.c",
+    "libsrc/ws2tcpip/gai_strerrorW.c",
+    "libsrc/wspiapi/WspiapiStrdup.c",
+    "libsrc/wspiapi/WspiapiParseV4Address.c",
+    "libsrc/wspiapi/WspiapiNewAddrInfo.c",
+    "libsrc/wspiapi/WspiapiQueryDNS.c",
+    "libsrc/wspiapi/WspiapiLookupNode.c",
+    "libsrc/wspiapi/WspiapiClone.c",
+    "libsrc/wspiapi/WspiapiLegacyFreeAddrInfo.c",
+    "libsrc/wspiapi/WspiapiLegacyGetAddrInfo.c",
+    "libsrc/wspiapi/WspiapiLegacyGetNameInfo.c",
+    "libsrc/wspiapi/WspiapiLoad.c",
+    "libsrc/wspiapi/WspiapiGetAddrInfo.c",
+    "libsrc/wspiapi/WspiapiGetNameInfo.c",
+    "libsrc/wspiapi/WspiapiFreeAddrInfo.c",
+]
+
 UCRT_BASE_SRCS = [
     "misc/ucrt__getmainargs.c",
     "misc/ucrt__wgetmainargs.c",
diff --git a/runtimes/mingw/import_libs.bzl b/runtimes/mingw/import_libs.bzl
index 1c10cfa..4d2890f 100644
--- a/runtimes/mingw/import_libs.bzl
+++ b/runtimes/mingw/import_libs.bzl
@@ -109,10 +109,14 @@ def mingw_import_libraries(name, directory):
 
     for lib_name, src in defs.items():
         target = "import_lib_" + lib_name
+        out_lib = "lib{}.a".format(lib_name)
+        if lib_name == "ws2_32":
+            out_lib = "libws2_32_import.a"
+
         run_binary(
             name = target,
             srcs = [src],
-            outs = ["lib{}.a".format(lib_name)],
+            outs = [out_lib],
             tool = "@toolchains_llvm_bootstrapped//tools:llvm-dlltool",
             args = select({
                 "@platforms//cpu:x86_64": ["-m", "i386:x86-64"],
@@ -132,7 +136,8 @@ def mingw_import_libraries(name, directory):
         # ucrtbase / ucrtbased are merged with extra objects elsewhere; keep
         # the generated targets available for direct deps, but do not expose
         # them via the directory filegroup to avoid shadowing the merged libs.
-        if lib_name not in ["ucrtbase", "ucrtbased"]:
+        # libws2_32 is merged with additional objects similarly.
+        if lib_name not in ["ucrtbase", "ucrtbased", "ws2_32"]:
             import_targets.append(target)
 
     native.filegroup(
