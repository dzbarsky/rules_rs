load("@bazel_lib//lib:transitions.bzl", "platform_transition_filegroup")

DISABLED = [
    "annotation_crate_features",
    #"binaries",
    #"build_script_aliases",
    #"build_script_env_select",
    #"build_script_runtime_env",
    #"build_dep_features",
    #"feature_name_overrides_implicit_dep",
    #"many_workspace_deps",
    #"multiple_versions_for_dependency",
    #"multiple_versions_of_optional_dep",
    #"non_optional_dep_feature",
    #"optional_build_deps",
    #"platform_dep_features",
    #"git_crates",
    #"uv",
]

TESTS = [f for f in glob(
    ["*"],
    exclude_directories = 0,
) if "." not in f and "bazel-" not in f and f not in DISABLED]

filegroup(
    name = "all_builds",
    srcs = ["@%s//:_workspace_deps" % test for test in TESTS] + [
        "@binaries//:protoc-gen-prost__protoc-gen-prost",
    ],
)

ALL_PLATFORMS = [
    "linux_arm64",
    "linux_amd64",
    #"linux_arm64_musl",
    #"linux_amd64_musl",
    "macos_amd64",
    "macos_arm64",
    "windows_amd64",
    "windows_arm64",
]

[
    platform_transition_filegroup(
        name = "all_builds_" + platform,
        target_platform = "@toolchains_llvm_bootstrapped//platforms:" + platform,
        srcs = ["all_builds"],
    )
    for platform in ALL_PLATFORMS
]

platform(
    name = "rbe",
    constraint_values = [
        "@platforms//cpu:x86_64",
        "@platforms//os:linux",
        "@bazel_tools//tools/cpp:clang",
    ],
    exec_properties = {
        "container-image": "docker://ubuntu:22.04",
        "OSFamily": "Linux",
    },
)
